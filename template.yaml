AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: WhatsApp Bot - Inbound Webhook Handler

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs18.x
    MemorySize: 256
    Environment:
      Variables:
        MESSAGE_LOG_TABLE_NAME: !Ref WhatsAppMessageLog
        INBOUND_QUEUE_URL: !Ref InboundMessageQueue

Resources:
  # DynamoDB Table for Message Logging
  WhatsAppMessageLog:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: WhatsAppMessageLog
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: mobile
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
        - AttributeName: conversationId
          AttributeType: S
      KeySchema:
        - AttributeName: mobile
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: conversation-index
          KeySchema:
            - AttributeName: conversationId
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  # DynamoDB Table for User Conversation State
  UserConversationState:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: UserConversationState
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: mobile
          AttributeType: S
        - AttributeName: conversationId
          AttributeType: S
        - AttributeName: lastInteraction
          AttributeType: N
      KeySchema:
        - AttributeName: mobile
          KeyType: HASH
        - AttributeName: conversationId
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: lastInteraction-index
          KeySchema:
            - AttributeName: lastInteraction
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  # DynamoDB Table for User Profile (CRM)
  UserProfile:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: UserProfile
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: mobile
          AttributeType: S
        - AttributeName: profileType
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: city
          AttributeType: S
      KeySchema:
        - AttributeName: mobile
          KeyType: HASH
        - AttributeName: profileType
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: status-index
          KeySchema:
            - AttributeName: status
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: city-index
          KeySchema:
            - AttributeName: city
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Human Escalation
  HumanEscalation:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: HumanEscalation
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: escalationId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
        - AttributeName: status
          AttributeType: S
        - AttributeName: mobile
          AttributeType: S
      KeySchema:
        - AttributeName: escalationId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: status-index
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: mobile-index
          KeySchema:
            - AttributeName: mobile
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Auth Users (SSO)
  AuthUser:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: AuthUser
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: mobile
          AttributeType: S
        - AttributeName: platform
          AttributeType: S
      KeySchema:
        - AttributeName: mobile
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: platform-index
          KeySchema:
            - AttributeName: platform
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for OTP Attempts (rate limit and audit)
  OTPAttempt:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: OTPAttempt
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: attemptId
          AttributeType: S
        - AttributeName: mobile
          AttributeType: S
        - AttributeName: requestedAt
          AttributeType: N
      KeySchema:
        - AttributeName: attemptId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: mobile-requestedAt-index
          KeySchema:
            - AttributeName: mobile
              KeyType: HASH
            - AttributeName: requestedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Payment Products (register product, amount, GST)
  PaymentProduct:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: PaymentProduct
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: productId
          AttributeType: S
        - AttributeName: entity
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: N
      KeySchema:
        - AttributeName: productId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: entity-createdAt-index
          KeySchema:
            - AttributeName: entity
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Payment Orders (Razorpay order + status at each step)
  PaymentOrder:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: PaymentOrder
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: orderId
          AttributeType: S
        - AttributeName: mobile
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: N
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: orderId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: mobile-createdAt-index
          KeySchema:
            - AttributeName: mobile
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: status-createdAt-index
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Payment Config (Razorpay keys in env; methods/notes in DB)
  PaymentConfig:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: PaymentConfig
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: configKey
          AttributeType: S
      KeySchema:
        - AttributeName: configKey
          KeyType: HASH

  # DynamoDB Table for Antakshari Teams
  AntakshariTeam:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: AntakshariTeam
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: teamId
          AttributeType: S
        - AttributeName: ownerMobile
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: N
      KeySchema:
        - AttributeName: teamId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ownerMobile-createdAt-index
          KeySchema:
            - AttributeName: ownerMobile
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB Table for Antakshari Team Members
  AntakshariMember:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: AntakshariMember
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: teamId
          AttributeType: S
        - AttributeName: memberIndex
          AttributeType: S
      KeySchema:
        - AttributeName: teamId
          KeyType: HASH
        - AttributeName: memberIndex
          KeyType: RANGE

  # SQS Queue for Inbound Messages
  InboundMessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: InboundMessageQueue
      VisibilityTimeout: 60  # Match Lambda timeout
      MessageRetentionPeriod: 345600  # 4 days

  # Lambda Function for Inbound Webhook
  GupshupInboundWebhook:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GupshupInboundWebhook
      CodeUri: src/inbound-webhook/
      Handler: app.handler
      Runtime: nodejs18.x
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          MESSAGE_LOG_TABLE_NAME: !Ref WhatsAppMessageLog
          INBOUND_QUEUE_URL: !Ref InboundMessageQueue
          WHATSAPP_BUSINESS_NUMBER: "916366743602"  # WhatsApp Business number in E.164 format
          GUPSHUP_VERIFICATION_KEY: "NYEV"  # Gupshup verification key
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref WhatsAppMessageLog
        - SQSSendMessagePolicy:
            QueueName: !GetAtt InboundMessageQueue.QueueName
        - CloudWatchLogsFullAccess
      Events:
        InboundWebhook:
          Type: Api
          Properties:
            Path: /webhook/inbound
            Method: post
            RestApiId: !Ref ApiGateway

  # Lambda Function for Conversation Processing
  ConversationProcessor:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ConversationProcessor
      CodeUri: src/conversation-processor/
      Handler: app.handler
      Runtime: nodejs18.x
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          USER_PROFILE_TABLE_NAME: !Ref UserProfile
          CONVERSATION_STATE_TABLE_NAME: !Ref UserConversationState
          MESSAGE_LOG_TABLE_NAME: !Ref WhatsAppMessageLog
          ESCALATION_TABLE_NAME: !Ref HumanEscalation
          GUPSHUP_USER_ID: "2000262614"  # Gupshup Login ID
          GUPSHUP_PASSWORD: "xk5sAZhq"  # Gupshup Password
          WHATSAPP_TEMPLATE_ID: ""  # WhatsApp Template ID (not needed for conversational messages)
          WHATSAPP_TEMPLATE_HAS_HEADER: "false"  # Set to "true" if template has header component
          WHATSAPP_TEMPLATE_HAS_FOOTER: "false"  # Set to "true" if template has footer component
          WHATSAPP_TEMPLATE_IS_INTERACTIVE: "false"  # Set to "true" if template has buttons (CTA/Quick Reply)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserProfile
        - DynamoDBCrudPolicy:
            TableName: !Ref UserConversationState
        - DynamoDBCrudPolicy:
            TableName: !Ref WhatsAppMessageLog
        - DynamoDBCrudPolicy:
            TableName: !Ref HumanEscalation
        - CloudWatchLogsFullAccess
      Events:
        ProcessMessage:
          Type: SQS
          Properties:
            Queue: !GetAtt InboundMessageQueue.Arn
            BatchSize: 1
            MaximumBatchingWindowInSeconds: 0

  # Lambda Function for Dashboard API
  DashboardAPI:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: DashboardAPI
      CodeUri: src/dashboard-api/
      Handler: app.handler
      Runtime: nodejs18.x
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          USER_PROFILE_TABLE_NAME: !Ref UserProfile
          CONVERSATION_STATE_TABLE_NAME: !Ref UserConversationState
          MESSAGE_LOG_TABLE_NAME: !Ref WhatsAppMessageLog
          ESCALATION_TABLE_NAME: !Ref HumanEscalation
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserProfile
        - DynamoDBCrudPolicy:
            TableName: !Ref UserConversationState
        - DynamoDBCrudPolicy:
            TableName: !Ref WhatsAppMessageLog
        - DynamoDBCrudPolicy:
            TableName: !Ref HumanEscalation
        - CloudWatchLogsFullAccess
      Events:
        DashboardStats:
          Type: Api
          Properties:
            Path: /dashboard/stats
            Method: get
            RestApiId: !Ref ApiGateway
        DashboardUsers:
          Type: Api
          Properties:
            Path: /dashboard/users
            Method: get
            RestApiId: !Ref ApiGateway
        DashboardConversations:
          Type: Api
          Properties:
            Path: /dashboard/conversations
            Method: get
            RestApiId: !Ref ApiGateway
        DashboardMessages:
          Type: Api
          Properties:
            Path: /dashboard/messages
            Method: get
            RestApiId: !Ref ApiGateway
        DashboardEscalations:
          Type: Api
          Properties:
            Path: /dashboard/escalations
            Method: get
            RestApiId: !Ref ApiGateway

  # Lambda Function for Auth API (JWT + OTP via WhatsApp)
  AuthAPI:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AuthAPI
      CodeUri: src/auth-api/
      Handler: app.handler
      Runtime: nodejs18.x
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          AUTH_USER_TABLE_NAME: !Ref AuthUser
          OTP_ATTEMPT_TABLE_NAME: !Ref OTPAttempt
          GUPSHUP_USER_ID: "2000261475"   # Template/OTP only (conversational uses different credentials)
          GUPSHUP_PASSWORD: "Op9uy64zU"
          JWT_ACCESS_SECRET: "change-me-in-production"
          JWT_REFRESH_SECRET: "change-me-refresh-in-production"
          JWT_ACCESS_EXPIRY: "1h"
          JWT_REFRESH_EXPIRY: "7d"
          USER_AUTH_TEMPLATE_ID: "1440838324490390"  # Or META Template ID from Gupshup Console (Templates -> info icon)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref AuthUser
        - DynamoDBCrudPolicy:
            TableName: !Ref OTPAttempt
        - CloudWatchLogsFullAccess
      Events:
        AuthOtpRequest:
          Type: Api
          Properties:
            Path: /auth/otp/request
            Method: post
            RestApiId: !Ref ApiGateway
        AuthOtpVerify:
          Type: Api
          Properties:
            Path: /auth/otp/verify
            Method: post
            RestApiId: !Ref ApiGateway
        AuthRefresh:
          Type: Api
          Properties:
            Path: /auth/refresh
            Method: post
            RestApiId: !Ref ApiGateway

  # Lambda Function for Payment API (Razorpay; JWT auth)
  PaymentAPI:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: PaymentAPI
      CodeUri: src/payment-api/
      Handler: app.handler
      Runtime: nodejs18.x
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          PAYMENT_PRODUCT_TABLE_NAME: !Ref PaymentProduct
          PAYMENT_ORDER_TABLE_NAME: !Ref PaymentOrder
          PAYMENT_CONFIG_TABLE_NAME: !Ref PaymentConfig
          JWT_ACCESS_SECRET: "change-me-in-production"
          RAZORPAY_KEY_ID: "rzp_live_SAqR5JwruL1avE"
          RAZORPAY_KEY_SECRET: "PhYERkRJUCViSWFk3NuerYQP"
          RAZORPAY_WEBHOOK_SECRET: "PhYERkRJUCViSWFk3NuerYQP"
          RAZORPAY_BUSINESS_NAME: "Merchant"
          RAZORPAY_TEST_MODE: "true"
          GUPSHUP_USER_ID: "2000261475"
          GUPSHUP_PASSWORD: "Op9uy64zU"
          ANTAKSHARI_CONFIRMATION_TEMPLATE_ID: "890136667129407"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PaymentProduct
        - DynamoDBCrudPolicy:
            TableName: !Ref PaymentOrder
        - DynamoDBCrudPolicy:
            TableName: !Ref PaymentConfig
        - CloudWatchLogsFullAccess
      Events:
        PaymentProductsPost:
          Type: Api
          Properties:
            Path: /payment/products
            Method: post
            RestApiId: !Ref ApiGateway
        PaymentProductsGet:
          Type: Api
          Properties:
            Path: /payment/products
            Method: get
            RestApiId: !Ref ApiGateway
        PaymentProductPatch:
          Type: Api
          Properties:
            Path: /payment/products/{productId}
            Method: patch
            RestApiId: !Ref ApiGateway
        PaymentConfigGet:
          Type: Api
          Properties:
            Path: /payment/config
            Method: get
            RestApiId: !Ref ApiGateway
        PaymentConfigPatch:
          Type: Api
          Properties:
            Path: /payment/config
            Method: patch
            RestApiId: !Ref ApiGateway
        PaymentOrdersPost:
          Type: Api
          Properties:
            Path: /payment/orders
            Method: post
            RestApiId: !Ref ApiGateway
        PaymentVerifyPost:
          Type: Api
          Properties:
            Path: /payment/verify
            Method: post
            RestApiId: !Ref ApiGateway
        PaymentPaymentsGet:
          Type: Api
          Properties:
            Path: /payment/payments
            Method: get
            RestApiId: !Ref ApiGateway
        PaymentWebhookPost:
          Type: Api
          Properties:
            Path: /payment/webhook
            Method: post
            RestApiId: !Ref ApiGateway

  # Lambda Function for Antakshari API (team, profile, members, link-order, list)
  AntakshariAPI:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AntakshariAPI
      CodeUri: src/antakshari-api/
      Handler: app.handler
      Runtime: nodejs18.x
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          ANTAKSHARI_TEAM_TABLE_NAME: !Ref AntakshariTeam
          ANTAKSHARI_MEMBER_TABLE_NAME: !Ref AntakshariMember
          USER_PROFILE_TABLE_NAME: !Ref UserProfile
          PAYMENT_ORDER_TABLE_NAME: !Ref PaymentOrder
          JWT_ACCESS_SECRET: "change-me-in-production"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref AntakshariTeam
        - DynamoDBCrudPolicy:
            TableName: !Ref AntakshariMember
        - DynamoDBCrudPolicy:
            TableName: !Ref UserProfile
        - DynamoDBCrudPolicy:
            TableName: !Ref PaymentOrder
        - CloudWatchLogsFullAccess
      Events:
        AntakshariTeamPost:
          Type: Api
          Properties:
            Path: /antakshari/team
            Method: post
            RestApiId: !Ref ApiGateway
        AntakshariProfileGet:
          Type: Api
          Properties:
            Path: /antakshari/profile
            Method: get
            RestApiId: !Ref ApiGateway
        AntakshariProfilePost:
          Type: Api
          Properties:
            Path: /antakshari/profile
            Method: post
            RestApiId: !Ref ApiGateway
        AntakshariTeamMembersPost:
          Type: Api
          Properties:
            Path: /antakshari/team/{teamId}/members
            Method: post
            RestApiId: !Ref ApiGateway
        AntakshariTeamLinkOrderPost:
          Type: Api
          Properties:
            Path: /antakshari/team/{teamId}/link-order
            Method: post
            RestApiId: !Ref ApiGateway
        AntakshariUsersGet:
          Type: Api
          Properties:
            Path: /antakshari/users
            Method: get
            RestApiId: !Ref ApiGateway
        AntakshariTeamsGet:
          Type: Api
          Properties:
            Path: /antakshari/teams
            Method: get
            RestApiId: !Ref ApiGateway

  # API Gateway REST API
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: WhatsAppBotApi
      StageName: prod
      Cors:
        AllowMethods: "'GET,POST,PATCH,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

Outputs:
  ApiGatewayUrl:
    Description: API Gateway endpoint URL for webhook
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod/webhook/inbound'
    Export:
      Name: !Sub '${AWS::StackName}-ApiGatewayUrl'
  
  DashboardApiUrl:
    Description: API Gateway base URL for dashboard API
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod'
    Export:
      Name: !Sub '${AWS::StackName}-DashboardApiUrl'
  
  AuthApiUrl:
    Description: API Gateway base URL for auth API (OTP + JWT)
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod'
    Export:
      Name: !Sub '${AWS::StackName}-AuthApiUrl'
  
  PaymentApiUrl:
    Description: API Gateway base URL for payment API (Razorpay)
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod'
    Export:
      Name: !Sub '${AWS::StackName}-PaymentApiUrl'
  
  InboundMessageQueueUrl:
    Description: SQS Queue URL for inbound messages
    Value: !Ref InboundMessageQueue
    Export:
      Name: !Sub '${AWS::StackName}-InboundMessageQueueUrl'
  
  WhatsAppMessageLogTableName:
    Description: DynamoDB Table name for message logs
    Value: !Ref WhatsAppMessageLog
    Export:
      Name: !Sub '${AWS::StackName}-WhatsAppMessageLogTableName'
  
  UserProfileTableName:
    Description: DynamoDB Table name for user profiles
    Value: !Ref UserProfile
    Export:
      Name: !Sub '${AWS::StackName}-UserProfileTableName'
  
  ConversationStateTableName:
    Description: DynamoDB Table name for conversation state
    Value: !Ref UserConversationState
    Export:
      Name: !Sub '${AWS::StackName}-ConversationStateTableName'
  
  HumanEscalationTableName:
    Description: DynamoDB Table name for human escalations
    Value: !Ref HumanEscalation
    Export:
      Name: !Sub '${AWS::StackName}-HumanEscalationTableName'

